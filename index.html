<!DOCTYPE html>
<html lang="en">
<head>
  <!-- META & STYLES -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agora Reporting Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"/>

  <style>
    /* Overall background and common styling (original look) */
    body{
      background-color:#d2d7dd;
      color:#000;
      font-family:Arial, sans-serif;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      margin:0;
    }
    .container, .record-container{
      background-color:#d2d7dd;
      padding:30px;
      border-radius:10px;
      box-shadow:0 0 20px rgba(0,0,0,0.5);
      max-width:800px;
      width:100%;
    }
    .record-container{ background:#fff; }

    h1, h2, h3, h4 { text-align:center; }
    h1, h2 { color:#333; }
    h3 { color:#002B5C; margin-top:20px; }
    h4 { color:#555; margin-top:10px; }

    label{ color:#000; margin-top:10px; }
    .checklist-item{ border-bottom:1px solid #e6e6e6; padding-bottom:10px; margin-bottom:10px; }

    button{
      background-color:#FFD700;
      color:#000;
      border:none;
      padding:10px 20px;
      cursor:pointer;
      display:inline-block;
      margin:10px 5px;
      border-radius:5px;
    }
    button:hover{ background-color:#E6C200; }
    .back-button{ background-color:#002B5C; color:#fff; }

    .image-upload{ display:none; } /* shown only when Attention Required */
    .image-preview{
      display:none;
      max-width:200px;
      max-height:200px;
      margin-top:5px;
      border:2px solid #ccc;
    }

    .calibration-container,
    .temp-extra-container{
      display:none;
      margin-top:10px;
      padding:10px;
      border:1px dashed #888;
    }

    /* Pilot Checks Page */
    .pilot-checks-container{ display:flex; flex-wrap:wrap; justify-content:space-around; }
    .farm-checks{
      background:#f8f9fa;
      border:1px solid #ddd;
      border-radius:5px;
      margin:10px;
      padding:15px;
      width:45%;
      min-width:280px;
    }
    .farm-checks ul{ list-style:none; padding:0; }
    .farm-checks li{ padding:5px 0; border-bottom:1px solid #ddd; }
    .farm-checks li:last-child{ border-bottom:none; }

    .version{ text-align:center; margin-top:20px; color:#333; font-size:12px; }
  </style>
</head>
<body>
  <!-- MAIN FORM CONTAINER -->
  <div class="container" id="form-container">
    <img src="https://firebasestorage.googleapis.com/v0/b/dairy-farm-record-system.appspot.com/o/Agora%20Logo%2F2F6-1YdaEP.jpeg?alt=media" alt="Logo" class="logo" style="display:block; margin:0 auto 20px; width:250px;">
    <h1>Agora Reporting Form</h1>

    <form id="hygiene-checklist-form">
      <!-- Farm Details -->
      <div class="section mb-4">
        <h2>Farm Details</h2>

        <label for="dairy-number">Dairy Number:</label>
        <input type="text" class="form-control" id="dairy-number" name="dairy-number" onblur="handleDairyNumberBlur();" autocapitalize="words" autocorrect="off" spellcheck="false">

        <label for="dairy-company">Dairy Company:</label>
        <input type="text" class="form-control" id="dairy-company" name="dairy-company" list="dairy-company-list" placeholder="Type or select..." autocapitalize="words" autocorrect="off" spellcheck="false">
        <datalist id="dairy-company-list"></datalist>

        <label for="address">Address:</label>
        <input type="text" class="form-control" id="address" name="address" autocapitalize="words" autocorrect="off" spellcheck="false">

        <label for="customer-name">Customer Name:</label>
        <input type="text" class="form-control" id="customer-name" name="customer-name" autocapitalize="words" autocorrect="off" spellcheck="false">

        <label for="region">Region:</label>
        <select id="region" name="region" class="form-select">
          <option value="northland">Northland</option>
          <option value="auckland">Auckland</option>
          <option value="waikato">Waikato</option>
          <option value="bay-of-plenty">Bay of Plenty</option>
          <option value="gisborne">Gisborne</option>
          <option value="hawkes-bay">Hawke's Bay</option>
          <option value="taranaki">Taranaki</option>
          <option value="manawatu-wanganui">Manawatu-Wanganui</option>
          <option value="wellington">Wellington</option>
          <option value="nelson">Nelson</option>
          <option value="marlborough">Marlborough</option>
          <option value="west-coast">West Coast</option>
          <option value="canterbury">Canterbury</option>
          <option value="otago">Otago</option>
          <option value="southland">Southland</option>
        </select>

        <label for="farm-name">Farm Name:</label>
        <input type="text" class="form-control" id="farm-name" name="farm-name" autocapitalize="words" autocorrect="off" spellcheck="false">

        <label for="island">Island:</label>
        <select id="island" name="island" class="form-select">
          <option value="north-island">North Island</option>
          <option value="south-island">South Island</option>
        </select>

        <label for="visit-date">Visit Date:</label>
        <input type="date" class="form-control" id="visit-date" name="visit-date">

        <label for="visit-type">Visit Type:</label>
        <input type="text" class="form-control" id="visit-type" name="visit-type" value="Milking Plant & Milk Vat Check" readonly autocapitalize="words" autocorrect="off" spellcheck="false">

        <label for="inspection-start-time">Inspection Start Time:</label>
        <input type="time" class="form-control" id="inspection-start-time" name="inspection-start-time">

        <label for="inspection-end-time">Inspection End Time:</label>
        <input type="time" class="form-control" id="inspection-end-time" name="inspection-end-time">

        <label for="inspection-completed-by">Inspection Completed By:</label>
        <input type="text" class="form-control" id="inspection-completed-by" name="inspection-completed-by" autocapitalize="words" autocorrect="off" spellcheck="false">

        <label for="call-type">Call Type:</label>
        <select id="call-type" name="call-type" class="form-select">
          <option value="alert">Alert</option>
          <option value="grade-call">Grade Call</option>
          <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
        </select>
      </div>

      <!-- Health & Safety -->
      <div class="section mb-4">
        <h2>Health & Safety</h2>
        <div id="health-safety-top"></div>
      </div>

      <!-- Plant Checklist -->
      <div class="section mb-4">
        <h2>Plant Checklist</h2>
        <div id="checklist-items"></div>
      </div>

      <!-- Silo Checklist -->
      <div class="section mb-4">
        <h2>Silo Checklist</h2>
        <div id="silo-checklist"></div>
      </div>

      <!-- Temperature Measurement -->
      <div class="section mb-4" id="temp-measurement-section">
        <h2>Temperature Measurement</h2>
        <div class="mb-3">
          <label for="hot-water-temp">Hot Water Temp (°C):</label>
          <input type="text" class="form-control" id="hot-water-temp" name="hot-water-temp">
        </div>
        <div class="mb-3">
          <label for="hot-water-time">Time Taken:</label>
          <input type="time" class="form-control" id="hot-water-time" name="hot-water-time" placeholder="--:-- --">
        </div>
        <div class="mb-3">
          <label for="milk-temp">Milk Temp (°C):</label>
          <input type="text" class="form-control" id="milk-temp" name="milk-temp">
        </div>
        <div class="mb-3">
          <label for="milk-time">Time Taken:</label>
          <input type="time" class="form-control" id="milk-time" name="milk-time" placeholder="--:-- --">
        </div>
      </div>

      <!-- Temperature Sensors -->
      <div class="section mb-4" id="temperature-sensors-container">
        <h2>Temperature Sensors</h2>
      </div>

      <!-- Flow Meters -->
      <div class="section mb-4" id="flow-meters-section">
        <h2>Flow Meters</h2>

        <!-- Acid -->
        <div class="flow-meter-item checklist-item">
          <h3>Acid Flow Meter</h3>
          <label for="acid-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="acid-flow-physical" name="acid-flow-physical">
          <label for="acid-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="acid-flow-system" name="acid-flow-system">
          <div class="calibration-container" id="acid-calibration">
            <label for="acid-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="acid-pulse-old" name="acid-pulse-old">
            <label for="acid-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="acid-pulse-new" name="acid-pulse-new">
            <label for="acid-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="acid-new-test-physical" name="acid-new-test-physical">
            <label for="acid-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="acid-new-system-result" name="acid-new-system-result">
          </div>
        </div>

        <!-- Chlor -->
        <div class="flow-meter-item checklist-item">
          <h3>Chlor Alkali Flow Meter</h3>
          <label for="chlor-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="chlor-flow-physical" name="chlor-flow-physical">
          <label for="chlor-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="chlor-flow-system" name="chlor-flow-system">
          <div class="calibration-container" id="chlor-calibration">
            <label for="chlor-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="chlor-pulse-old" name="chlor-pulse-old">
            <label for="chlor-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="chlor-pulse-new" name="chlor-pulse-new">
            <label for="chlor-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="chlor-new-test-physical" name="chlor-new-test-physical">
            <label for="chlor-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="chlor-new-system-result" name="chlor-new-system-result">
          </div>
        </div>

        <!-- Teat -->
        <div class="flow-meter-item checklist-item">
          <h3>Teat Concentrate Flow Meter</h3>
          <label for="teat-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="teat-flow-physical" name="teat-flow-physical">
          <label for="teat-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="teat-flow-system" name="teat-flow-system">
          <div class="calibration-container" id="teat-calibration">
            <label for="teat-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="teat-pulse-old" name="teat-pulse-old">
            <label for="teat-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="teat-pulse-new" name="teat-pulse-new">
            <label for="teat-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="teat-new-test-physical" name="teat-new-test-physical">
            <label for="teat-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="teat-new-system-result" name="teat-new-system-result">
          </div>
        </div>

        <!-- Water -->
        <div class="flow-meter-item checklist-item">
          <h3>Water Flow Meter</h3>
          <label for="water-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="water-flow-physical" name="water-flow-physical">
          <label for="water-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="water-flow-system" name="water-flow-system">
          <div class="calibration-container" id="water-calibration">
            <label for="water-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="water-pulse-old" name="water-pulse-old">
            <label for="water-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="water-pulse-new" name="water-pulse-new">
            <label for="water-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="water-new-test-physical" name="water-new-test-physical">
            <label for="water-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="water-new-system-result" name="water-new-system-result">
          </div>
        </div>
      </div>

      <!-- Hidden: used when admin loads a previous form so we overwrite same file -->
      <input type="hidden" id="existing-file-name" name="existing-file-name" value="">

      <!-- Buttons -->
      <div style="text-align:center;">
        <button type="button" onclick="generatePDF()">Generate PDF</button>
        <button type="button" onclick="viewRecords()">View All Records</button>
        <button type="button" onclick="pilotChecks()">Pilot Checks</button>
        <!-- Admin -->
        <button type="button" class="back-button" onclick="adminLoadLastForm()">Admin: Load Last Form</button>
      </div>
    </form>

    <div class="version">Version 6.2 (Agora)</div>
  </div>

  <!-- RECORDS VIEW -->
  <div id="record-container" class="record-container" style="display:none;">
    <h2>All Agora Records</h2>
    <div class="search-container">
      <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecords()">
    </div>
    <div id="record-list" class="record-list"></div>
    <button class="back-button" onclick="goBack()">Back to Checklist</button>
  </div>

  <!-- PILOT CHECKS PAGE -->
  <div id="pilot-checks-page" class="record-container" style="display:none;">
    <h2>Upcoming Agora Shed Checks</h2>
    <div class="pilot-checks-container">
      <div class="farm-checks">
        <h3>Brandmar Farm</h3>
        <h4>Upcoming Checks</h4>
        <ul><li>Annual Check – Due: 19th June 2025</li></ul>
        <h4>Completed Checks</h4>
        <ul>
          <li>Install Date: 19th June 2024</li>
          <li>2 Week Check: 3rd July 2024</li>
          <li>3 Month Check: 19th Sep 2024</li>
          <li>6 Month Check: 19th Dec 2024</li>
        </ul>
      </div>
      <div class="farm-checks">
        <h3>J Block</h3>
        <h4>Upcoming Checks</h4>
        <ul>
          <li>6 Month Check – Due: 3rd June 2025</li>
          <li>Annual Check – Due: 3rd Dec 2025</li>
        </ul>
        <h4>Completed Checks</h4>
        <ul>
          <li>Install Date: 3rd Dec 2024</li>
          <li>2 Week Check: 17th Dec 2024</li>
          <li>3 Month Check: 3rd Mar 2025</li>
        </ul>
      </div>
      <div class="farm-checks">
        <h3>Pukerimu</h3>
        <h4>Upcoming Checks</h4>
        <ul><li>Annual Check – Due: 23rd Aug 2025</li></ul>
        <h4>Completed Checks</h4>
        <ul>
          <li>Install Date: 23rd Aug 2024</li>
          <li>2 Week Check: 6th Sep 2024</li>
          <li>3 Month Check: 22nd Nov 2024</li>
          <li>6 Month Check: 24th Feb 2025</li>
        </ul>
      </div>
      <div class="farm-checks">
        <h3>Ferry View</h3>
        <h4>Upcoming Checks</h4>
        <ul>
          <li>6 Month Check – Due: 19th Aug 2025</li>
          <li>Annual Check – Due: 19th Feb 2025</li>
        </ul>
        <h4>Completed Checks</h4>
        <ul>
          <li>Install Date: 19th Feb 2025</li>
          <li>2 Week Check: 11th Mar 2025</li>
          <li>3 Month Check – Due: 19th May 2025</li>
        </ul>
      </div>
    </div>
    <div style="text-align:center;">
      <button class="back-button" onclick="backToForm()">Back to Checklist</button>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    /* -------------------- FIREBASE & DEXIE INIT -------------------- */
    const { jsPDF } = window.jspdf;
    const firebaseConfig = {
      apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
      authDomain: "dairy-farm-record-system.firebaseapp.com",
      projectId: "dairy-farm-record-system",
      storageBucket: "dairy-farm-record-system.appspot.com",
      messagingSenderId: "422124188212",
      appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
    const firestore = firebase.firestore();

    const db = new Dexie("OfflineData");
    db.version(5).stores({
      forms: "dairyNumber",
      dairyCompanies: "++id, name",
      teatSprayRatios: "++id, ratio",
      pdfQueue: "++id,dairyNumber,fileName,uploaded,target"
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registered:', reg.scope))
        .catch(err => console.error('SW registration failed:', err));
    }

    /* -------------------- UTILITIES -------------------- */
    function toTitleCase(str){ return str.replace(/\w\S*/g, t => t[0].toUpperCase()+t.substr(1).toLowerCase()); }
    function autoCapitalizeInput(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('blur', () => { el.value = toTitleCase(el.value); });
    }

    async function setupDairyCompanyDatalist(){
      const defaults = ["Fonterra","Dairy Goat Co-op","Green Valley Dairies","Maui Milk","Oceania","OFI","Synlait Milk LTD","Tatua","Danone","Fresha Valley LTD","Mataura Valley Milk","Open Country Dairy LTD","Waiu","Westland Milk Products"];
      const user = await db.dairyCompanies.toArray();
      const all = [...defaults];
      user.forEach(u => { if (!all.includes(u.name)) all.push(u.name); });
      const dl = document.getElementById('dairy-company-list');
      dl.innerHTML = "";
      all.forEach(c => { const o=document.createElement('option'); o.value=c; dl.appendChild(o); });

      const input = document.getElementById('dairy-company');
      input.addEventListener('blur', async () => {
        input.value = toTitleCase(input.value.trim());
        if (input.value && !all.includes(input.value)) {
          await db.dairyCompanies.add({ name: input.value });
          all.push(input.value);
          const o=document.createElement('option'); o.value=input.value; dl.appendChild(o);
        }
      });
    }

    async function fetchFarmDetails(){
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      const storageRef = storage.ref(`Agora Farm Details/${dairyNumber}.json`);
      try{
        const url = await storageRef.getDownloadURL();
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch farm details');
        const data = await response.json();
        if (data){
          document.getElementById('dairy-company').value  = toTitleCase(data.dairyCompany || '');
          document.getElementById('address').value        = toTitleCase(data.address || '');
          document.getElementById('customer-name').value  = toTitleCase(data.customerName || '');
          document.getElementById('region').value         = data.region || '';
          document.getElementById('farm-name').value      = toTitleCase(data.farmName || '');
          document.getElementById('island').value         = data.island || '';
        }
      }catch(e){ console.log('No farm details found or error:', e); }
    }

    async function checkOrCreateFormRecord(){
      const dn = document.getElementById('dairy-number').value.trim();
      if (!dn) return;
      let record = await db.forms.get(dn);
      if (!record){
        record = { dairyNumber: dn, formData: {}, creationTime: Date.now() };
        await db.forms.put(record);
      }
    }
    async function handleDairyNumberBlur(){ await fetchFarmDetails(); await checkOrCreateFormRecord(); }

    /* -------------------- CHECKLIST BUILDERS -------------------- */
    function buildRow(container, labelText, statusName, commentsName){
      const wrap = document.createElement('div');
      wrap.className = 'checklist-item';

      const label = document.createElement('label');
      label.textContent = labelText;
      wrap.appendChild(label);

      const select = document.createElement('select');
      select.className = 'form-select';
      select.name = statusName;
      select.innerHTML = `
        <option value="ok">OK</option>
        <option value="attention-required">Attention Required</option>
        <option value="na">N/A</option>
        <option value="not-checked">Not Checked</option>`;
      wrap.appendChild(select);

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control';
      input.name = commentsName;
      input.placeholder = 'Comments';
      input.setAttribute('spellcheck','true');
      input.setAttribute('autocorrect','on');   // autocorrect ON for comments
      input.setAttribute('autocomplete','on');
      wrap.appendChild(input);

      for (let i=0;i<2;i++){
        const fi = document.createElement('input');
        fi.type = 'file';
        fi.className = 'form-control image-upload';
        const img = document.createElement('img');
        img.className = 'image-preview';
        wrap.appendChild(fi);
        wrap.appendChild(img);
        fi.addEventListener('change', async () => {
          if (fi.files && fi.files[0]){
            const b64 = await convertFileToBase64(fi.files[0]);
            img.src = b64; img.style.display = 'block';
          }
        });
      }

      select.addEventListener('change', ()=>{
        const show = select.value === 'attention-required';
        wrap.querySelectorAll('input[type="file"]').forEach(f => f.style.display = show ? 'block' : 'none');
      });

      container.appendChild(wrap);
    }

    function createHealthSafetyItems(containerId){
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      buildRow(container, "Health & Safety Notes", "status-health-safety-notes", "comments-health-safety-notes");
    }

    function createChecklistItems(){
      const items = [
        "Pulsator Airline","Long Bend Elbows","Automatic Cup and Remover","Diaphragm","Receiving Can",
        "Sanitary Trap","Main Milk Line","Milk Line Seals in Good Condition","Stainless Droppers","Long Milk Rubber",
        "Liner","Cluster","Cluster Seal","Cluster Button","Non Return Valve at Milk Pump","Milk Pump",
        "Filter Housing","Plate Cooler","Interceptor","Receiver Airline","Flushing Pulsator","Air Purge Valve",
        "Vacuum Level","Main Airline","Plant Drainage - Milk Pump","Plant Drainage - Filter/s","Plant Drainage - Plate Cooler",
        "Plant Drainage - Vat Entry","Plant Wash Tap","Wash Jetters","Centre Gland","Test Bucket"
      ];
      const container = document.getElementById("checklist-items");
      container.innerHTML = "";
      items.forEach(item => buildRow(container, item, `status-${item}`, `comments-${item}`));
    }

    function createSiloChecklist(){
      const items = ["Inlet Valve","Non-Return Valve","Spray Ball","Agitator","Silo Door","Manhole Seal","Vat Outlet","Walls in Silo"];
      const container = document.getElementById("silo-checklist");
      container.innerHTML = "";
      items.forEach(item => buildRow(container, item, `status-${item}`, `comments-${item}`));
    }

    function createTemperatureSensorItem(){
      const container = document.getElementById("temperature-sensors-container");
      container.innerHTML = "";

      const row = document.createElement('div');
      row.className = 'checklist-item';

      const mainLabel = document.createElement('label');
      mainLabel.textContent = 'Temperature Sensor';
      row.appendChild(mainLabel);

      const statusSelect = document.createElement('select');
      statusSelect.className = 'form-select';
      statusSelect.name = 'tempSensor-status';
      statusSelect.innerHTML = `
        <option value="ok">OK</option>
        <option value="attention-required">Attention Required</option>
        <option value="na">N/A</option>
        <option value="not-checked">Not Checked</option>`;
      row.appendChild(statusSelect);

      const type = document.createElement('input');
      type.type = 'text';
      type.className = 'form-control';
      type.name = 'tempSensor-type';
      type.placeholder = 'Sensor Type (e.g. Plant Inlet Temp)';
      row.appendChild(type);

      const tested = document.createElement('input');
      tested.type = 'text';
      tested.className = 'form-control';
      tested.name = 'tempSensor-tested';
      tested.placeholder = 'Tested °C';
      row.appendChild(tested);

      const system = document.createElement('input');
      system.type = 'text';
      system.className = 'form-control';
      system.name = 'tempSensor-system';
      system.placeholder = 'System °C';
      row.appendChild(system);

      const comments = document.createElement('input');
      comments.type = 'text';
      comments.className = 'form-control';
      comments.name = 'tempSensor-comments';
      comments.placeholder = 'Comments';
      comments.setAttribute('spellcheck','true');
      comments.setAttribute('autocorrect','on');   // autocorrect ON
      comments.setAttribute('autocomplete','on');
      row.appendChild(comments);

      for (let i=0;i<2;i++){
        const fi = document.createElement('input'); fi.type='file'; fi.className='form-control image-upload';
        const img = document.createElement('img'); img.className='image-preview';
        row.appendChild(fi); row.appendChild(img);
        fi.addEventListener('change', async ()=>{
          if (fi.files && fi.files[0]){ const b64=await convertFileToBase64(fi.files[0]); img.src=b64; img.style.display='block'; }
        });
      }

      statusSelect.addEventListener('change', ()=>{
        const show = statusSelect.value === 'attention-required';
        row.querySelectorAll('input[type="file"]').forEach(f => f.style.display = show ? 'block' : 'none');
      });

      container.appendChild(row);
    }

    /* -------------------- LOAD / SAVE -------------------- */
    function loadFormDataFromRecord(record){
      const data = record.formData || {};
      document.getElementById("dairy-number").value = record.dairyNumber;

      for (let key in data){
        if (key === "checklistItems" || key === "temperatureSensors") continue;
        const field = document.getElementById(key) || document.getElementsByName(key)[0];
        if (field) field.value = data[key];
      }

      if (data.checklistItems){
        const containers = [
          ...document.getElementById("health-safety-top").children,
          ...document.getElementById("checklist-items").children,
          ...document.getElementById("silo-checklist").children
        ];
        containers.forEach(container=>{
          const label = container.querySelector("label");
          if (!label) return;
          const key = label.textContent.trim();
          if (data.checklistItems[key]){
            const { status, comments, imagesBase64 } = data.checklistItems[key];
            const sel = container.querySelector("select");
            if (sel){ sel.value = status; sel.dispatchEvent(new Event("change")); }
            const txt = container.querySelector('input[type="text"]');
            if (txt) txt.value = comments || "";
            if (imagesBase64 && imagesBase64.length){
              const previews = container.querySelectorAll(".image-preview");
              imagesBase64.forEach((b64,i)=>{ if (previews[i]){ previews[i].src=b64; previews[i].style.display="block"; } });
            }
          }
        });
      }

      if (data.temperatureSensors){
        const ts = data.temperatureSensors;
        const row = document.querySelector("#temperature-sensors-container .checklist-item");
        if (row){
          row.querySelector("select").value = ts.status || "";
          row.querySelector("select").dispatchEvent(new Event("change"));
          row.querySelector("input[name='tempSensor-type']").value = ts.type || "";
          row.querySelector("input[name='tempSensor-tested']").value = ts.tested || "";
          row.querySelector("input[name='tempSensor-system']").value = ts.system || "";
          row.querySelector("input[name='tempSensor-comments']").value = ts.comments || "";
        }
      }
    }

    function clearEntireForm(){
      document.getElementById("hygiene-checklist-form").reset();
      document.querySelectorAll(".image-upload").forEach(i => i.style.display="none");
      document.querySelectorAll(".image-preview").forEach(i => { i.src=""; i.style.display="none"; });
      document.getElementById("existing-file-name").value = "";
    }

    async function saveFormData(){
      const dn = document.getElementById("dairy-number").value.trim();
      if (!dn) return;

      let record = await db.forms.get(dn);
      if (!record) record = { dairyNumber: dn, formData: {}, creationTime: Date.now() };

      const form = document.getElementById("hygiene-checklist-form");
      const formDataObj = new FormData(form);
      const data = Object.fromEntries(Array.from(formDataObj.entries()).filter(([k,v]) => (v ?? "").toString().trim() !== ""));

      const sections = [
        ...document.getElementById("health-safety-top").children,
        ...document.getElementById("checklist-items").children,
        ...document.getElementById("silo-checklist").children
      ];

      const checklistItemsData = {};
      for (let c of sections){
        const label = c.querySelector("label");
        if (!label) continue;
        const key = label.textContent.trim();

        const sel = c.querySelector("select");
        const status = sel ? sel.value : "";

        const txt = c.querySelector('input[type="text"]');
        let comments = txt ? txt.value : "";

        const files = c.querySelectorAll('input[type="file"]');
        const imagesBase64 = [];
        for (let fi of files){
          if (fi.files && fi.files[0]){
            imagesBase64.push(await convertFileToBase64(fi.files[0]));
          }
        }
        if (status === "attention-required" && imagesBase64.length){
          comments += imagesBase64.length > 1 ? " (see attached photos)" : " (see attached photo)";
        }
        checklistItemsData[key] = { status, comments, imagesBase64 };
      }
      data.checklistItems = checklistItemsData;

      const tsRow = document.querySelector("#temperature-sensors-container .checklist-item");
      if (tsRow){
        data.temperatureSensors = {
          status:   tsRow.querySelector("select").value,
          type:     tsRow.querySelector("input[name='tempSensor-type']").value,
          tested:   tsRow.querySelector("input[name='tempSensor-tested']").value,
          system:   tsRow.querySelector("input[name='tempSensor-system']").value,
          comments: tsRow.querySelector("input[name='tempSensor-comments']").value
        };
      }

      record.formData = data;
      await db.forms.put(record);
    }

    function convertFileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function saveFarmDetailsToFirebase(fd){
      const dairyNumber = fd.get("dairy-number") || "";
      if (!dairyNumber) return;
      const details = {
        dairyCompany: fd.get("dairy-company") || "",
        address: fd.get("address") || "",
        customerName: fd.get("customer-name") || "",
        region: fd.get("region") || "",
        farmName: fd.get("farm-name") || "",
        island: fd.get("island") || ""
      };
      const blob = new Blob([JSON.stringify(details)], { type:"application/json" });
      try{
        const ref = storage.ref(`Agora Farm Details/${dairyNumber}.json`);
        await ref.put(blob);
      }catch(err){ console.error("Error saving farm details JSON:", err); }
    }

    async function uploadPendingPDFs(){
      if (!navigator.onLine) return;
      const queued = await db.pdfQueue.toArray();
      for (let p of queued){
        if (p.target === "customers"){
          try{
            await uploadSinglePDFCustomer(p.dairyNumber, p.fileName, p.pdfBlob);
            await db.pdfQueue.delete(p.id);
          }catch(err){ console.error("Retry PDF upload to Customers failed:", err); }
        }
      }
    }

    function uploadSinglePDFCustomer(dairyNumber, fileName, pdfBlob){
      return new Promise((resolve,reject)=>{
        const ref = storage.ref(`Agora Customers/${dairyNumber}/${fileName}`);
        const task = ref.put(pdfBlob);
        task.on("state_changed", null, e=>reject(e), ()=>resolve());
      });
    }

    /* ---------- SNAPSHOT storage for Admin Load ---------- */
    async function uploadFormSnapshot(dairyNumber, snapshotObj){
      const blob = new Blob([JSON.stringify(snapshotObj)], { type: "application/json" });
      const ref  = storage.ref(`Agora Form Snapshots/${dairyNumber}/last.json`);
      await ref.put(blob);
    }

    async function fetchFormSnapshot(dairyNumber){
      const ref = storage.ref(`Agora Form Snapshots/${dairyNumber}/last.json`);
      try{
        const url = await ref.getDownloadURL();
        const res = await fetch(url);
        if(!res.ok) throw new Error("Snapshot fetch failed");
        return await res.json();
      }catch(e){
        console.log("No snapshot available for", dairyNumber, e);
        return null;
      }
    }

    async function adminLoadLastForm(){
      const dn = (prompt("Enter Dairy Number to load last saved form:") || "").trim();
      if(!dn) return;

      // Try Firebase snapshot first
      const snap = await fetchFormSnapshot(dn);
      if(snap && snap.formData){
        loadFormDataFromRecord({ dairyNumber: dn, formData: snap.formData });
        document.getElementById("existing-file-name").value = snap.lastFileName || "";
        document.getElementById("dairy-number").value = dn;
        alert("Last saved form loaded for " + dn + ". Edit and Generate PDF to overwrite the same file.");
        return;
      }

      // Fallback to local draft
      const local = await db.forms.get(dn);
      if(local){
        loadFormDataFromRecord(local);
        document.getElementById("existing-file-name").value = "";
        alert("Loaded local draft for " + dn + ".");
      }else{
        alert("No last form found for " + dn + ".");
      }
    }

    window.addEventListener("online", uploadPendingPDFs);

    /* -------------------- PDF (ORIGINAL STYLE) -------------------- */
    async function generatePDF(){
      const dairyNumber = document.getElementById("dairy-number").value.trim();
      if (!dairyNumber){ alert("Please enter a Dairy Number."); return; }

      const form = document.getElementById("hygiene-checklist-form");
      const fd = new FormData(form);
      await saveFarmDetailsToFirebase(fd);

      // Build checklist data + collect photos
      const sections = [
        ...document.getElementById("health-safety-top").children,
        ...document.getElementById("checklist-items").children,
        ...document.getElementById("silo-checklist").children
      ];
      const checklistData = [];
      const photoStore = [];
      const imagePromises = [];

      sections.forEach(item=>{
        const labelEl = item.querySelector("label"); if (!labelEl) return;
        const itemName = labelEl.textContent;
        const status = item.querySelector("select")?.value || "";
        let comments = item.querySelector("input[type='text']")?.value || "";

        // Files chosen now
        const fileInputs = item.querySelectorAll("input[type='file']");
        const images = [];
        fileInputs.forEach(inp => { if (inp.files && inp.files[0]) images.push(inp.files[0]); });

        // Also include any previews already on screen (e.g., when loading snapshot)
        const previews = item.querySelectorAll(".image-preview");
        previews.forEach(p=>{
          if (p.src && p.src.startsWith("data:")) {
            const b64 = p.src;
            // treat existing previews as images too
            const idx = (photoStore.find(ps=>ps.itemName===itemName) || {images:[]}).images.length;
            if (!photoStore.find(ps=>ps.itemName===itemName)){
              photoStore.push({ itemName, images: [] });
            }
            photoStore.find(ps=>ps.itemName===itemName).images.push(b64);
          }
        });

        if (images.length){
          let p = photoStore.find(ps => ps.itemName === itemName);
          if(!p){ p = { itemName, images: [] }; photoStore.push(p); }
          images.forEach((file, idx)=>{
            imagePromises.push(convertFileToBase64(file).then(b64 => { p.images.push(b64); }));
          });
        }

        // Only append note if attention-required and there are images
        const hasImages = (photoStore.find(ps=>ps.itemName===itemName)?.images.length || 0) > 0;
        if (status === "attention-required" && hasImages){
          comments += hasImages > 1 ? " (see attached photos)" : " (see attached photo)";
        }

        checklistData.push([itemName, status, comments]);
      });

      // Temperature Sensors
      let tempSensorData = [];
      let tempSensorNote = "";
      const tsRow = document.querySelector("#temperature-sensors-container .checklist-item");
      if (tsRow){
        const s  = tsRow.querySelector("select")?.value || "";
        const ty = tsRow.querySelector("input[name='tempSensor-type']")?.value || "";
        const tt = tsRow.querySelector("input[name='tempSensor-tested']")?.value || "";
        const sy = tsRow.querySelector("input[name='tempSensor-system']")?.value || "";
        const cm = tsRow.querySelector("input[name='tempSensor-comments']")?.value || "";
        if (s === "ok") tempSensorNote = "All temperature probes were tested and are within specification.";
        else if (s === "attention-required") tempSensorData.push([ty, tt, sy, cm]);
      }

      // Flow meters
      const flowMeters = [];
      const map = {
        "Acid Flow Meter":  { main:"acid-flow",  extra:"acid"  },
        "Chlor Alkali Flow Meter": { main:"chlor-flow", extra:"chlor" },
        "Teat Concentrate Flow Meter": { main:"teat-flow",  extra:"teat"  },
        "Water Flow Meter": { main:"water-flow", extra:"water" }
      };
      for (const meter of Object.keys(map)){
        const px = map[meter];
        const physical = (fd.get(px.main+"-physical") || "").trim();
        const system   = (fd.get(px.main+"-system")   || "").trim();
        if (physical || system){
          flowMeters.push([meter, physical ? physical+" ml" : "", system ? system+" ml" : ""]);
        }

        const pulseOld = (fd.get(px.extra+"-pulse-old") || "").trim();
        const pulseNew = (fd.get(px.extra+"-pulse-new") || "").trim();
        const newPhys  = (fd.get(px.extra+"-new-test-physical") || "").trim();
        const newSys   = (fd.get(px.extra+"-new-system-result") || "").trim();

        if (pulseOld || pulseNew || newPhys || newSys){
          let left = "", right = "";
          if (pulseOld) left += "Pulse Old: " + pulseOld;
          if (pulseNew) left += (left ? ", " : "") + "Pulse New: " + pulseNew;
          if (newPhys) right += "Test Physical: " + newPhys;
          if (newSys)  right += (right ? ", " : "") + "System Result: " + newSys;
          flowMeters.push(["Calibration:", left, right]);
        }
      }

      await Promise.all(imagePromises);

      // Prepare PDF
      const pdf = new jsPDF("p","pt","a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const side = 40;
      const top = 40;
      const bottom = 40;
      let currentY = top;

      function ensure(h){ if (currentY + h > pageHeight - bottom){ pdf.addPage(); currentY = top; } }

      // Logo
      try{
        const url = await storage.ref("Agora Logo/2F6-1YdaEP.jpeg").getDownloadURL();
        const blob = await fetch(url).then(r=>r.blob());
        const b64 = await convertFileToBase64(blob);
        const img = new Image(); await new Promise(r => { img.onload = r; img.src = b64; });
        const W = 150, H = (img.height * W) / img.width;
        pdf.addImage(b64, "JPEG", (pageWidth - W)/2, currentY, W, H);
        currentY += H + 20;
      }catch(e){}

      // Farm details
      const leftColLabelWidth = 595 * 0.15;
      const leftColValueWidth = 595 * 0.20;
      const rightColLabelWidth = 595 * 0.20;
      const rightColValueWidth = 595 * 0.30;
      const farmDetailsRows = [
        [{content:"Dairy Company:",styles:{fontStyle:"bold"}},{content:(fd.get("dairy-company")||""),styles:{fontStyle:"normal"}},{content:"Visit Type:",styles:{fontStyle:"bold"}},{content:(fd.get("visit-type")||""),styles:{fontStyle:"normal"}}],
        [{content:"Dairy Number:",styles:{fontStyle:"bold"}},{content:(fd.get("dairy-number")||""),styles:{fontStyle:"normal"}},{content:"Inspection Start Time:",styles:{fontStyle:"bold"}},{content:(fd.get("inspection-start-time")||""),styles:{fontStyle:"normal"}}],
        [{content:"Address:",styles:{fontStyle:"bold"}},{content:(fd.get("address")||""),styles:{fontStyle:"normal"}},{content:"Inspection End Time:",styles:{fontStyle:"bold"}},{content:(fd.get("inspection-end-time")||""),styles:{fontStyle:"normal"}}],
        [{content:"Customer Name:",styles:{fontStyle:"bold"}},{content:(fd.get("customer-name")||""),styles:{fontStyle:"normal"}},{content:"Inspection Completed By:",styles:{fontStyle:"bold"}},{content:(fd.get("inspection-completed-by")||""),styles:{fontStyle:"normal"}}],
        [{content:"Visit Date:",styles:{fontStyle:"bold"}},{content:(fd.get("visit-date")||""),styles:{fontStyle:"normal"}},{content:"Call Type:",styles:{fontStyle:"bold"}},{content:(fd.get("call-type")||""),styles:{fontStyle:"normal"}}]
      ];
      pdf.autoTable({
        startY: currentY,
        head: [["Farm Details","","",""]],
        body: farmDetailsRows,
        theme: "grid",
        styles: { fontSize:10, cellPadding:6, lineColor:[220,224,230], lineWidth:0.2 },
        headStyles: { fillColor:[0,43,92], textColor:255 },
        margin: { left: side, right: side },
        columnStyles: { 0:{cellWidth:leftColLabelWidth}, 1:{cellWidth:leftColValueWidth}, 2:{cellWidth:rightColLabelWidth, halign:"right"}, 3:{cellWidth:rightColValueWidth, halign:"right"} }
      });
      currentY = pdf.lastAutoTable.finalY + 20;

      // Temperature measurement
      const tempMeasurementData = [
        ["Hot Water Temp (°C):", fd.get("hot-water-temp") || ""],
        ["Time Taken:", fd.get("hot-water-time") || "--:-- --"],
        ["Milk Temp (°C):", fd.get("milk-temp") || ""],
        ["Time Taken:", fd.get("milk-time") || "--:-- --"]
      ];
      pdf.autoTable({
        startY: currentY,
        head: [["Temperature Measurement",""]],
        body: tempMeasurementData,
        theme: "grid",
        styles: { fontSize:10, cellPadding:6, lineColor:[220,224,230], lineWidth:0.2 },
        headStyles: { fillColor:[0,43,92], textColor:255 },
        margin: { left: side, right: side },
        columnStyles: { 0:{cellWidth:250} }
      });
      currentY = pdf.lastAutoTable.finalY + 20;

      // Checklist (navy header + light stripe rows)
      pdf.autoTable({
        startY: currentY,
        head: [["Item","Status","Comments"]],
        body: checklistData,
        theme: "grid",
        styles: { fontSize:10, cellPadding:6, lineColor:[220,224,230], lineWidth:0.2 },
        headStyles: { fillColor:[0,43,92], textColor:255 },
        alternateRowStyles: { fillColor:[245,247,250] },
        margin: { left: side, right: side },
        columnStyles: { 0:{cellWidth:320}, 1:{cellWidth:80}, 2:{cellWidth:"auto"} }
      });
      currentY = pdf.lastAutoTable.finalY + 20;

      // Temperature Sensors block
      if (tempSensorNote || tempSensorData.length){
        pdf.setFont("helvetica","bold");
        ensure(20); pdf.text("Temperature Sensors:", side, currentY); currentY += 14;
        if (tempSensorNote){
          pdf.setFont("helvetica","normal");
          const wrapped = pdf.splitTextToSize(tempSensorNote, pageWidth - side*2);
          ensure(wrapped.length*12 + 6);
          pdf.text(wrapped, side, currentY);
          currentY += wrapped.length*12 + 8;
        }
        if (tempSensorData.length){
          pdf.autoTable({
            startY: currentY,
            head: [["Sensor Type","Tested Temp (°C)","System Temp (°C)","Comments"]],
            body: tempSensorData,
            theme: "grid",
            styles: { fontSize:10, cellPadding:6, lineColor:[220,224,230], lineWidth:0.2 },
            headStyles: { fillColor:[0,43,92], textColor:255 },
            alternateRowStyles: { fillColor:[245,247,250] },
            margin: { left: side, right: side }
          });
          currentY = pdf.lastAutoTable.finalY + 20;
        }
      }

      // Flow meters
      if (flowMeters.length){
        pdf.setFont("helvetica","bold");
        ensure(20); pdf.text("Flow Meters:", side, currentY); currentY += 10;
        pdf.autoTable({
          startY: currentY,
          head: [["Meter","Physical Test","System Read"]],
          body: flowMeters,
          theme: "grid",
          styles: { fontSize:10, cellPadding:6, lineColor:[220,224,230], lineWidth:0.2 },
          headStyles: { fillColor:[0,43,92], textColor:255 },
          alternateRowStyles: { fillColor:[245,247,250] },
          margin: { left: side, right: side },
          columnStyles: { 0:{cellWidth:240}, 1:{cellWidth:120}, 2:{cellWidth:"auto"} }
        });
        currentY = pdf.lastAutoTable.finalY + 20;
      }

      // Photos
      if (photoStore.length){
        pdf.setFont("helvetica","bold");
        ensure(20); pdf.text("Attached Photos:", side, currentY); currentY += 20;

        for (const photoItem of photoStore){
          if (!photoItem.images.length) continue;
          ensure(15); pdf.text(photoItem.itemName, side, currentY); currentY += 15;
          let maxImgHeight = 0;
          for (let i=0;i<photoItem.images.length;i++){
            try{
              const props = pdf.getImageProperties(photoItem.images[i]);
              const w = 250, h = (props.height * w) / props.width;
              ensure(h + 10);
              pdf.addImage(photoItem.images[i], "JPEG", side + i*(w+10), currentY, w, h);
              if (h > maxImgHeight) maxImgHeight = h;
            }catch(e){}
          }
          currentY += maxImgHeight + 20;
        }
      }

      // ---- Upload + Save (with snapshot + same-name overwrite) ----
      const visitDate = fd.get("visit-date");
      if (!visitDate){ alert("Visit Date is required."); return; }
      const parts = visitDate.split("-");
      const stamp = parts[2] + "-" + parts[1] + "-" + parts[0].substr(2);

      let fileName = (document.getElementById("existing-file-name").value || "").trim();
      if(!fileName){ fileName = `${fd.get("dairy-number")}-form-${stamp}.pdf`; }

      // Build a full snapshot of this form to save to Firebase
      const fullSnapshot = {
        dairyNumber: fd.get("dairy-number") || "",
        lastFileName: fileName,
        formData: (()=>{
          const data = {};
          // Base fields
          const formDataObj = new FormData(document.getElementById("hygiene-checklist-form"));
          for(const [k,v] of formDataObj.entries()){ if(k) data[k] = v; }

          // Checklist w/ photos from photoStore (and visible previews)
          const sections2 = [
            ...document.getElementById("health-safety-top").children,
            ...document.getElementById("checklist-items").children,
            ...document.getElementById("silo-checklist").children
          ];
          const checklistItemsData = {};
          for (let c of sections2){
            const label = c.querySelector("label"); if (!label) continue;
            const key   = label.textContent.trim();
            const sel   = c.querySelector("select");
            const status= sel ? sel.value : "";
            const txt   = c.querySelector('input[type="text"]');
            const comments = txt ? txt.value : "";

            // Aggregate images from previews first
            let imagesBase64 = [];
            c.querySelectorAll(".image-preview").forEach(p=>{
              if (p.src && p.src.startsWith("data:")) imagesBase64.push(p.src);
            });
            // Then add any freshly-chosen files already converted and collected
            const ps = (photoStore || []).find(p => p.itemName === key);
            if(ps && ps.images && ps.images.length){
              // avoid duplicates
              ps.images.forEach(b64 => { if(!imagesBase64.includes(b64)) imagesBase64.push(b64); });
            }

            checklistItemsData[key] = { status, comments, imagesBase64 };
          }
          data.checklistItems = checklistItemsData;

          // Temperature sensors
          const tsR = document.querySelector("#temperature-sensors-container .checklist-item");
          if (tsR){
            data.temperatureSensors = {
              status:   tsR.querySelector("select")?.value || "",
              type:     tsR.querySelector("input[name='tempSensor-type']")?.value || "",
              tested:   tsR.querySelector("input[name='tempSensor-tested']")?.value || "",
              system:   tsR.querySelector("input[name='tempSensor-system']")?.value || "",
              comments: tsR.querySelector("input[name='tempSensor-comments']")?.value || ""
            };
          }
          return data;
        })()
      };

      const pdfBlob = pdf.output("blob");

      // 1) Upload / overwrite the PDF
      try{ await uploadSinglePDFCustomer(dairyNumber, fileName, pdfBlob); }
      catch(e){ await db.pdfQueue.add({ dairyNumber, fileName, pdfBlob, uploaded:false, target:"customers" }); }

      // 2) Save/overwrite the snapshot JSON
      try{ await uploadFormSnapshot(dairyNumber, fullSnapshot); }
      catch(e){ console.error("Snapshot upload failed:", e); }

      // Reset UI
      db.forms.delete(fd.get("dairy-number"));
      pdf.save(fileName);
      uploadPendingPDFs();
      clearEntireForm();
      location.reload();
    }

    /* -------------------- RECORDS / NAV -------------------- */
    function viewRecords(){
      document.getElementById("form-container").style.display="none";
      document.getElementById("pilot-checks-page").style.display="none";
      document.getElementById("record-container").style.display="block";
      loadAllRecords();
    }

    async function loadAllRecords(){
      const recordList = document.getElementById("record-list");
      recordList.innerHTML = "";
      const storageRef = storage.ref("Agora Customers");
      try{
        const folderSnapshot = await storageRef.listAll();

        if (folderSnapshot.prefixes.length){
          folderSnapshot.prefixes.forEach(folderRef=>{
            const dn = folderRef.name;
            const a = document.createElement("a");
            a.textContent = dn; a.href = "#"; a.style.display="block";
            a.addEventListener("click", ()=>loadRecordFiles(dn));
            recordList.appendChild(a);
          });
        }

        if (folderSnapshot.items.length){
          folderSnapshot.items.forEach(fileRef=>{
            const a = document.createElement("a");
            a.textContent = fileRef.name; a.href = "#"; a.style.display="block";
            a.addEventListener("click", async ()=>{
              try{ const url = await fileRef.getDownloadURL(); window.open(url, "_blank"); }
              catch(err){ console.error("Error fetching file:", err); }
            });
            recordList.appendChild(a);
          });
        }
      }catch(e){ console.error("Error fetching records:", e); }
    }

    async function loadRecordFiles(dairyNumber){
      const list = document.getElementById("record-list");
      list.innerHTML = "";
      const folderRef = storage.ref(`Agora Customers/${dairyNumber}`);
      try{
        const snap = await folderRef.listAll();
        snap.items.forEach(fileRef=>{
          const name = fileRef.name;
          const match = name.match(/(\d{4}-\d{2}-\d{2})/);
          const displayName = match ? match[0] : name;
          const a=document.createElement("a");
          a.textContent=displayName; a.href="#"; a.style.display="block";
          a.addEventListener("click", async ()=>{
            try{ const url = await fileRef.getDownloadURL(); window.open(url, "_blank"); }
            catch(err){ console.error("Error fetching record file:", err); }
          });
          list.appendChild(a);
        });
        const back=document.createElement("button");
        back.textContent="Back to Records"; back.className="back-button"; back.addEventListener("click", loadAllRecords);
        list.appendChild(back);
      }catch(err){ console.error("Error fetching record files:", err); }
    }

    function filterRecords(){
      const q = document.getElementById("search-dairy-number").value.toLowerCase();
      const links = document.getElementById("record-list").getElementsByTagName("a");
      for (let i=0;i<links.length;i++){
        const txt = links[i].textContent || links[i].innerText;
        links[i].style.display = txt.toLowerCase().includes(q) ? "" : "none";
      }
    }

    function goBack(){
      document.getElementById("record-container").style.display="none";
      document.getElementById("form-container").style.display="block";
    }
    function pilotChecks(){
      document.getElementById("form-container").style.display="none";
      document.getElementById("record-container").style.display="none";
      document.getElementById("pilot-checks-page").style.display="block";
    }
    function backToForm(){
      document.getElementById("pilot-checks-page").style.display="none";
      document.getElementById("form-container").style.display="block";
    }

    /* Flow meter tolerance reveal */
    function setupFlowMeterTolerance(physicalId, systemId, calibrationId){
      const p = document.getElementById(physicalId);
      const s = document.getElementById(systemId);
      const box = document.getElementById(calibrationId);
      function update(){
        const pv = parseFloat(p.value);
        const sv = parseFloat(s.value);
        if (!isNaN(pv) && !isNaN(sv)){
          const tol = 0.05 * pv;
          box.style.display = (Math.abs(pv - sv) > tol) ? "block" : "none";
        } else {
          box.style.display = "none";
        }
      }
      p.addEventListener("input", update);
      s.addEventListener("input", update);
    }

    /* -------------------- BOOTSTRAP -------------------- */
    document.addEventListener("DOMContentLoaded", async ()=>{
      ["dairy-number","dairy-company","address","customer-name","farm-name","inspection-completed-by"].forEach(autoCapitalizeInput);
      await setupDairyCompanyDatalist();
      createHealthSafetyItems("health-safety-top");
      createChecklistItems();
      createSiloChecklist();
      createTemperatureSensorItem();

      const form = document.getElementById("hygiene-checklist-form");
      form.addEventListener("input", saveFormData);
      form.addEventListener("change", saveFormData);

      uploadPendingPDFs();

      setupFlowMeterTolerance("acid-flow-physical","acid-flow-system","acid-calibration");
      setupFlowMeterTolerance("chlor-flow-physical","chlor-flow-system","chlor-calibration");
      setupFlowMeterTolerance("teat-flow-physical","teat-flow-system","teat-calibration");
      setupFlowMeterTolerance("water-flow-physical","water-flow-system","water-calibration");
    });
  </script>
</body>
</html>