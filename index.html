<!DOCTYPE html>
<html lang="en">
<head>
  <!-- META & STYLES -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agora Reporting Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <style>
    /* Overall background set to #d2d7dd */
    body {
      background-color: #d2d7dd;
      color: #000;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      margin: 0;
    }
    .container {
      background-color: #d2d7dd;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      max-width: 800px;
      width: 100%;
    }
    h1, h2 { color: #333; text-align: center; }
    h1 { margin-bottom: 40px; }
    /* Ensure labels remain black */
    label { color: #000; margin-top: 10px; }
    button {
      background-color: #FFD700;
      color: #000; /* Button text now black */
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      display: block;
      margin: 20px auto;
      border-radius: 5px;
    }
    button:hover { background-color: #E6C200; }
    .checklist-item { margin-bottom: 30px; }
    .form-control, .form-select { margin-top: 5px; }
    .version { text-align: center; margin-top: 20px; color: #333; font-size: 12px; }
    .logo { display: block; margin: 0 auto 20px; width: 250px; }
    .record-container {
      background-color: #fff;
      color: #000;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      max-width: 1000px;
      width: 100%;
      margin: 20px auto;
    }
    .record-container h2 { color: #002B5C; }
    .record-list { max-height: 400px; overflow-y: auto; }
    .record-list a {
      text-decoration: none;
      color: #007bff;
      display: block;
      margin-bottom: 10px;
    }
    .back-button {
      margin-top: 20px;
      background-color: #002B5C;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    .search-container { margin-bottom: 20px; }
    /* Hide image uploads by default */
    .image-upload { display: none; }
    .image-preview {
      display: none;
      max-width: 200px;
      max-height: 200px;
      margin-top: 5px;
      border: 2px solid #ccc;
    }
    /* Calibration and extra fields hidden by default */
    .calibration-container,
    .temp-extra-container { display: none; margin-top: 10px; padding: 10px; border: 1px dashed #888; }
  </style>
</head>
<body>
  <!-- MAIN FORM CONTAINER -->
  <div class="container" id="form-container">
    <!-- Small Logo from "Agora Logo" folder -->
    <img src="https://firebasestorage.googleapis.com/v0/b/dairy-farm-record-system.appspot.com/o/Agora%20Logo%2F6-1YdaEP.jpeg?alt=media" alt="Logo" class="logo">
    <h1>Agora Reporting Form</h1>
    <form id="hygiene-checklist-form">
      <!-- Farm Details Section -->
      <div class="section mb-4">
        <h2>Farm Details</h2>
        <label for="dairy-number">Dairy Number:</label>
        <input type="text" class="form-control" id="dairy-number" name="dairy-number" onblur="handleDairyNumberBlur();" autocapitalize="words" autocorrect="off" spellcheck="false">
        <label for="dairy-company">Dairy Company:</label>
        <input type="text" class="form-control" id="dairy-company" name="dairy-company" list="dairy-company-list" placeholder="Type or select..." autocapitalize="words" autocorrect="off" spellcheck="false">
        <datalist id="dairy-company-list"></datalist>
        <label for="address">Address:</label>
        <input type="text" class="form-control" id="address" name="address" autocapitalize="words" autocorrect="off" spellcheck="false">
        <label for="customer-name">Customer Name:</label>
        <input type="text" class="form-control" id="customer-name" name="customer-name" autocapitalize="words" autocorrect="off" spellcheck="false">
        <label for="region">Region:</label>
        <select id="region" name="region" class="form-select">
          <option value="northland">Northland</option>
          <option value="auckland">Auckland</option>
          <option value="waikato">Waikato</option>
          <option value="bay-of-plenty">Bay of Plenty</option>
          <option value="gisborne">Gisborne</option>
          <option value="hawkes-bay">Hawke's Bay</option>
          <option value="taranaki">Taranaki</option>
          <option value="manawatu-wanganui">Manawatu-Wanganui</option>
          <option value="wellington">Wellington</option>
          <option value="nelson">Nelson</option>
          <option value="marlborough">Marlborough</option>
          <option value="west-coast">West Coast</option>
          <option value="canterbury">Canterbury</option>
          <option value="otago">Otago</option>
          <option value="southland">Southland</option>
        </select>
        <label for="farm-name">Farm Name:</label>
        <input type="text" class="form-control" id="farm-name" name="farm-name" autocapitalize="words" autocorrect="off" spellcheck="false">
        <label for="island">Island:</label>
        <select id="island" name="island" class="form-select">
          <option value="north-island">North Island</option>
          <option value="south-island">South Island</option>
        </select>
        <label for="visit-date">Visit Date:</label>
        <input type="date" class="form-control" id="visit-date" name="visit-date">
        <label for="visit-type">Visit Type:</label>
        <input type="text" class="form-control" id="visit-type" name="visit-type" value="Milking Plant & Milk Vat Check" readonly autocapitalize="words" autocorrect="off" spellcheck="false">
        <label for="inspection-start-time">Inspection Start Time:</label>
        <input type="time" class="form-control" id="inspection-start-time" name="inspection-start-time">
        <label for="inspection-end-time">Inspection End Time:</label>
        <input type="time" class="form-control" id="inspection-end-time" name="inspection-end-time">
        <label for="inspection-completed-by">Inspection Completed By:</label>
        <input type="text" class="form-control" id="inspection-completed-by" name="inspection-completed-by" autocapitalize="words" autocorrect="off" spellcheck="false">
        <label for="call-type">Call Type:</label>
        <select id="call-type" name="call-type" class="form-select">
          <option value="alert">Alert</option>
          <option value="grade-call">Grade Call</option>
          <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
        </select>
      </div>
      
      <!-- Health & Safety Section -->
      <div class="section mb-4">
        <h2>Health & Safety</h2>
        <div id="health-safety-top"></div>
      </div>
      
      <!-- Plant Checklist Section -->
      <div class="section mb-4">
        <h2>Plant Checklist</h2>
        <div id="checklist-items"></div>
      </div>
      
      <!-- Silo Checklist Section -->
      <div class="section mb-4">
        <h2>Silo Checklist</h2>
        <div id="silo-checklist"></div>
      </div>
      
      <!-- New Temperature Sensors Section -->
      <div class="section mb-4" id="temperature-sensors-container">
        <h2>Temperature Sensors</h2>
      </div>
      
      <!-- Flow Meters Section -->
      <div class="section mb-4" id="flow-meters-section">
        <h2>Flow Meters</h2>
        <!-- Acid Flow Meter -->
        <div class="flow-meter-item checklist-item">
          <h3>Acid Flow Meter</h3>
          <label for="acid-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="acid-flow-physical" name="acid-flow-physical">
          <label for="acid-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="acid-flow-system" name="acid-flow-system">
          <div class="calibration-container" id="acid-calibration">
            <label for="acid-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="acid-pulse-old" name="acid-pulse-old">
            <label for="acid-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="acid-pulse-new" name="acid-pulse-new">
            <label for="acid-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="acid-new-test-physical" name="acid-new-test-physical">
            <label for="acid-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="acid-new-system-result" name="acid-new-system-result">
          </div>
        </div>
        <!-- Chlor Alkali Flow Meter -->
        <div class="flow-meter-item checklist-item">
          <h3>Chlor Alkali Flow Meter</h3>
          <label for="chlor-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="chlor-flow-physical" name="chlor-flow-physical">
          <label for="chlor-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="chlor-flow-system" name="chlor-flow-system">
          <div class="calibration-container" id="chlor-calibration">
            <label for="chlor-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="chlor-pulse-old" name="chlor-pulse-old">
            <label for="chlor-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="chlor-pulse-new" name="chlor-pulse-new">
            <label for="chlor-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="chlor-new-test-physical" name="chlor-new-test-physical">
            <label for="chlor-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="chlor-new-system-result" name="chlor-new-system-result">
          </div>
        </div>
        <!-- Teat Concentrate Flow Meter -->
        <div class="flow-meter-item checklist-item">
          <h3>Teat Concentrate Flow Meter</h3>
          <label for="teat-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="teat-flow-physical" name="teat-flow-physical">
          <label for="teat-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="teat-flow-system" name="teat-flow-system">
          <div class="calibration-container" id="teat-calibration">
            <label for="teat-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="teat-pulse-old" name="teat-pulse-old">
            <label for="teat-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="teat-pulse-new" name="teat-pulse-new">
            <label for="teat-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="teat-new-test-physical" name="teat-new-test-physical">
            <label for="teat-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="teat-new-system-result" name="teat-new-system-result">
          </div>
        </div>
        <!-- Water Flow Meter -->
        <div class="flow-meter-item checklist-item">
          <h3>Water Flow Meter</h3>
          <label for="water-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="water-flow-physical" name="water-flow-physical">
          <label for="water-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="water-flow-system" name="water-flow-system">
          <div class="calibration-container" id="water-calibration">
            <label for="water-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="water-pulse-old" name="water-pulse-old">
            <label for="water-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="water-pulse-new" name="water-pulse-new">
            <label for="water-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="water-new-test-physical" name="water-new-test-physical">
            <label for="water-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="water-new-system-result" name="water-new-system-result">
          </div>
        </div>
      </div>
      
      <button type="button" onclick="generatePDF()">Generate PDF</button>
      <button type="button" onclick="viewRecords()">View All Records</button>
    </form>
    <div class="version">Version 6.9 (Agora)</div>
  </div>
  
  <!-- RECORDS VIEW -->
  <div id="record-container" class="record-container" style="display: none;">
    <h2>All Agora Records</h2>
    <div class="search-container">
      <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecords()">
    </div>
    <div id="record-list" class="record-list"></div>
    <button class="back-button" onclick="goBack()">Back to Checklist</button>
  </div>
  
  <!-- SCRIPTS -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    /* FIREBASE & DEXIE INIT */
    const { jsPDF } = window.jspdf;
    const firebaseConfig = {
      apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
      authDomain: "dairy-farm-record-system.firebaseapp.com",
      projectId: "dairy-farm-record-system",
      storageBucket: "dairy-farm-record-system.appspot.com",
      messagingSenderId: "422124188212",
      appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
    const firestore = firebase.firestore();
    const db = new Dexie("OfflineData");
    db.version(5).stores({
      forms: "dairyNumber",
      dairyCompanies: "++id, name",
      teatSprayRatios: "++id, ratio",
      pdfQueue: "++id,dairyNumber,fileName,uploaded"
    });
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registered:', reg.scope))
        .catch(err => console.error('SW registration failed:', err));
    }
    
    /* Utility Functions */
    function toTitleCase(str) {
      return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
      });
    }
    function autoCapitalizeInput(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('blur', () => { el.value = toTitleCase(el.value); });
    }
    
    async function setupDairyCompanyDatalist() {
      const defaultCompanies = [
        "Fonterra", "Dairy Goat Co-op", "Green Valley Dairies", "Maui Milk",
        "Oceania", "OFI", "Synlait Milk LTD", "Tatua", "Danone", "Fresha Valley LTD",
        "Mataura Valley Milk", "Open Country Dairy LTD", "Waiu", "Westland Milk Products"
      ];
      const userCompanies = await db.dairyCompanies.toArray();
      const allCompanies = [...defaultCompanies];
      userCompanies.forEach(u => { if (!allCompanies.includes(u.name)) { allCompanies.push(u.name); } });
      const datalist = document.getElementById('dairy-company-list');
      datalist.innerHTML = "";
      allCompanies.forEach(c => { 
        const opt = document.createElement('option');
        opt.value = c;
        datalist.appendChild(opt);
      });
      const dairyCompanyInput = document.getElementById('dairy-company');
      dairyCompanyInput.addEventListener('blur', async () => {
        dairyCompanyInput.value = toTitleCase(dairyCompanyInput.value.trim());
        const typedValue = dairyCompanyInput.value;
        if (typedValue && !allCompanies.includes(typedValue)) {
          await db.dairyCompanies.add({ name: typedValue });
          allCompanies.push(typedValue);
          const newOpt = document.createElement('option');
          newOpt.value = typedValue;
          datalist.appendChild(newOpt);
        }
      });
    }
    
    async function fetchFarmDetails() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      const storageRef = storage.ref(`Agora Farm Details/${dairyNumber}.json`);
      try {
        const url = await storageRef.getDownloadURL();
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch farm details');
        const data = await response.json();
        if (data) {
          document.getElementById('dairy-company').value = toTitleCase(data.dairyCompany || '');
          document.getElementById('address').value = toTitleCase(data.address || '');
          document.getElementById('customer-name').value = toTitleCase(data.customerName || '');
          document.getElementById('region').value = data.region || '';
          document.getElementById('farm-name').value = toTitleCase(data.farmName || '');
          document.getElementById('island').value = data.island || '';
        }
      } catch (error) {
        console.log('No farm details found or error:', error);
      }
    }
    
    async function checkOrCreateFormRecord() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      let record = await db.forms.get(dairyNumber);
      if (!record) {
        record = { dairyNumber, formData: {}, creationTime: Date.now() };
        await db.forms.put(record);
      }
    }
    async function handleDairyNumberBlur() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      fetchFarmDetails();
      await checkOrCreateFormRecord();
    }
    
    /* Create checklist items similar to original */
    function createHealthSafetyItems(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      const itemContainer = document.createElement("div");
      itemContainer.classList.add("checklist-item");
      const label = document.createElement("label");
      label.textContent = "Health & Safety Notes";
      itemContainer.appendChild(label);
      const statusSelect = document.createElement("select");
      statusSelect.classList.add("form-select");
      statusSelect.name = "status-health-safety-notes";
      statusSelect.innerHTML = `
        <option value="ok">OK</option>
        <option value="attention-required">Attention Required</option>
        <option value="na">N/A</option>
        <option value="not-checked">Not Checked</option>
      `;
      itemContainer.appendChild(statusSelect);
      const commentsInput = document.createElement("input");
      commentsInput.type = "text";
      commentsInput.classList.add("form-control");
      commentsInput.name = "comments-health-safety-notes";
      commentsInput.placeholder = "Comments";
      commentsInput.setAttribute("spellcheck", "true");
      commentsInput.setAttribute("autocorrect", "off");
      itemContainer.appendChild(commentsInput);
      // Two file inputs hidden by default
      for (let i = 0; i < 2; i++) {
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.classList.add("form-control", "image-upload");
        itemContainer.appendChild(fileInput);
        const preview = document.createElement("img");
        preview.classList.add("image-preview");
        itemContainer.appendChild(preview);
      }
      statusSelect.addEventListener("change", () => {
        const fileInputs = itemContainer.querySelectorAll('input[type="file"]');
        fileInputs.forEach(inp => {
          inp.style.display = (statusSelect.value === "attention-required") ? "block" : "none";
        });
      });
      container.appendChild(itemContainer);
    }
    
    function createChecklistItems() {
      const checklistItems = [
        "Pulsator Airline", "Long Bend Elbows", "Automatic Cup and Remover", "Diaphragm", "Receiving Can",
        "Sanitary Trap", "Main Milk Line", "Milk Line Seals in Good Condition", "Stainless Droppers", "Long Milk Rubber",
        "Liner", "Cluster", "Cluster Seal", "Cluster Button", "Non Return Valve at Milk Pump", "Milk Pump",
        "Filter Housing", "Plate Cooler", "Interceptor", "Receiver Airline", "Flushing Pulsator", "Air Purge Valve",
        "Vacuum Level", "Main Airline", "Plant Drainage - Milk Pump", "Plant Drainage - Filter/s", "Plant Drainage - Plate Cooler",
        "Plant Drainage - Vat Entry", "Plant Wash Tap", "Wash Jetters", "Centre Gland", "Test Bucket"
      ];
      const container = document.getElementById("checklist-items");
      container.innerHTML = "";
      checklistItems.forEach(item => {
        const itemContainer = document.createElement("div");
        itemContainer.classList.add("checklist-item");
        const label = document.createElement("label");
        label.textContent = item;
        itemContainer.appendChild(label);
        const statusSelect = document.createElement("select");
        statusSelect.classList.add("form-select");
        statusSelect.name = `status-${item}`;
        statusSelect.innerHTML = `
          <option value="ok">OK</option>
          <option value="attention-required">Attention Required</option>
          <option value="na">N/A</option>
          <option value="not-checked">Not Checked</option>
        `;
        itemContainer.appendChild(statusSelect);
        const commentsInput = document.createElement("input");
        commentsInput.type = "text";
        commentsInput.classList.add("form-control");
        commentsInput.name = `comments-${item}`;
        commentsInput.placeholder = "Comments";
        commentsInput.setAttribute("spellcheck", "true");
        commentsInput.setAttribute("autocorrect", "off");
        itemContainer.appendChild(commentsInput);
        for (let i = 0; i < 2; i++) {
          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.classList.add("form-control", "image-upload");
          itemContainer.appendChild(fileInput);
          const preview = document.createElement("img");
          preview.classList.add("image-preview");
          itemContainer.appendChild(preview);
        }
        statusSelect.addEventListener("change", () => {
          const fileInputs = itemContainer.querySelectorAll('input[type="file"]');
          fileInputs.forEach(inp => {
            inp.style.display = (statusSelect.value === "attention-required") ? "block" : "none";
          });
        });
        container.appendChild(itemContainer);
      });
    }
    
    function createSiloChecklist() {
      const siloItems = [
        "Inlet Valve", "Non-Return Valve", "Spray Ball", "Agitator",
        "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
      ];
      const container = document.getElementById("silo-checklist");
      container.innerHTML = "";
      siloItems.forEach(item => {
        const itemContainer = document.createElement("div");
        itemContainer.classList.add("checklist-item");
        const label = document.createElement("label");
        label.textContent = item;
        itemContainer.appendChild(label);
        const statusSelect = document.createElement("select");
        statusSelect.classList.add("form-select");
        statusSelect.name = `status-${item}`;
        statusSelect.innerHTML = `
          <option value="ok">OK</option>
          <option value="attention-required">Attention Required</option>
          <option value="na">N/A</option>
          <option value="not-checked">Not Checked</option>
        `;
        itemContainer.appendChild(statusSelect);
        const commentsInput = document.createElement("input");
        commentsInput.type = "text";
        commentsInput.classList.add("form-control");
        commentsInput.name = `comments-${item}`;
        commentsInput.placeholder = "Comments";
        commentsInput.setAttribute("spellcheck", "true");
        commentsInput.setAttribute("autocorrect", "off");
        itemContainer.appendChild(commentsInput);
        for (let i = 0; i < 2; i++) {
          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.classList.add("form-control", "image-upload");
          itemContainer.appendChild(fileInput);
          const preview = document.createElement("img");
          preview.classList.add("image-preview");
          itemContainer.appendChild(preview);
        }
        statusSelect.addEventListener("change", () => {
          const fileInputs = itemContainer.querySelectorAll('input[type="file"]');
          fileInputs.forEach(inp => {
            inp.style.display = (statusSelect.value === "attention-required") ? "block" : "none";
          });
        });
        container.appendChild(itemContainer);
      });
    }
    
    /* New Temperature Sensor Item */
    function createTemperatureSensorItem() {
      const container = document.getElementById("temperature-sensors-container");
      const sensorItem = document.createElement("div");
      sensorItem.classList.add("checklist-item");
      const mainLabel = document.createElement("label");
      mainLabel.textContent = "Temperature Sensor";
      sensorItem.appendChild(mainLabel);
      const statusSelect = document.createElement("select");
      statusSelect.classList.add("form-select");
      statusSelect.name = "tempSensor-status";
      statusSelect.innerHTML = `
        <option value="ok">OK</option>
        <option value="attention-required">Attention Required</option>
        <option value="na">N/A</option>
        <option value="not-checked">Not Checked</option>
      `;
      sensorItem.appendChild(statusSelect);
      
      const extraContainer = document.createElement("div");
      extraContainer.classList.add("temp-extra-container");
      // Sensor Type
      const sensorTypeLabel = document.createElement("label");
      sensorTypeLabel.textContent = "Sensor Type (e.g. Plant Inlet Temp):";
      extraContainer.appendChild(sensorTypeLabel);
      const sensorTypeInput = document.createElement("input");
      sensorTypeInput.type = "text";
      sensorTypeInput.classList.add("form-control");
      sensorTypeInput.name = "tempSensor-type";
      sensorTypeInput.placeholder = "Enter sensor type";
      extraContainer.appendChild(sensorTypeInput);
      // Tested Temperature
      const testedLabel = document.createElement("label");
      testedLabel.textContent = "Tested Temperature (°C):";
      extraContainer.appendChild(testedLabel);
      const testedInput = document.createElement("input");
      testedInput.type = "text";
      testedInput.classList.add("form-control");
      testedInput.name = "tempSensor-tested";
      extraContainer.appendChild(testedInput);
      // System Temperature
      const systemLabel = document.createElement("label");
      systemLabel.textContent = "System Temperature (°C):";
      extraContainer.appendChild(systemLabel);
      const systemInput = document.createElement("input");
      systemInput.type = "text";
      systemInput.classList.add("form-control");
      systemInput.name = "tempSensor-system";
      extraContainer.appendChild(systemInput);
      // Comments
      const tempCommentsLabel = document.createElement("label");
      tempCommentsLabel.textContent = "Comments:";
      extraContainer.appendChild(tempCommentsLabel);
      const tempCommentsInput = document.createElement("input");
      tempCommentsInput.type = "text";
      tempCommentsInput.classList.add("form-control");
      tempCommentsInput.name = "tempSensor-comments";
      extraContainer.appendChild(tempCommentsInput);
      // Two photo uploads
      for (let i = 0; i < 2; i++) {
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.classList.add("form-control", "image-upload");
        extraContainer.appendChild(fileInput);
        const preview = document.createElement("img");
        preview.classList.add("image-preview");
        extraContainer.appendChild(preview);
      }
      sensorItem.appendChild(extraContainer);
      statusSelect.addEventListener("change", () => {
        extraContainer.style.display = (statusSelect.value === "attention-required") ? "block" : "none";
      });
      container.appendChild(sensorItem);
    }
    
    /* LOAD, CLEAR & SAVE Data */
    function loadFormDataFromRecord(record) {
      const data = record.formData || {};
      document.getElementById("dairy-number").value = record.dairyNumber;
      for (let key in data) {
        if (key === "checklistItems" || key === "temperatureSensors") continue;
        const field = document.getElementById(key) || document.getElementsByName(key)[0];
        if (field) { field.value = data[key]; }
      }
      if (data.checklistItems) {
        const containers = [
          ...document.getElementById("health-safety-top").children,
          ...document.getElementById("checklist-items").children,
          ...document.getElementById("silo-checklist").children
        ];
        containers.forEach(container => {
          const label = container.querySelector("label");
          if (!label) return;
          const key = label.textContent.trim();
          if (data.checklistItems[key]) {
            const { status, comments, imagesBase64 } = data.checklistItems[key];
            const statusSelect = container.querySelector("select");
            if (statusSelect) {
              statusSelect.value = status;
              statusSelect.dispatchEvent(new Event("change"));
            }
            const commentsInput = container.querySelector('input[type="text"]');
            if (commentsInput) { commentsInput.value = comments; }
            if (imagesBase64 && imagesBase64.length > 0) {
              const previews = container.querySelectorAll(".image-preview");
              imagesBase64.forEach((img64, i) => {
                if (previews[i]) {
                  previews[i].src = img64;
                  previews[i].style.display = "block";
                }
              });
            }
          }
        });
      }
      if (data.temperatureSensors) {
        const tsData = data.temperatureSensors;
        const container = document.getElementById("temperature-sensors-container");
        const sensorItem = container.querySelector(".checklist-item");
        if (sensorItem) {
          sensorItem.querySelector("select").value = tsData.status || "";
          sensorItem.querySelector("select").dispatchEvent(new Event("change"));
          sensorItem.querySelector("input[name='tempSensor-type']").value = tsData.type || "";
          sensorItem.querySelector("input[name='tempSensor-tested']").value = tsData.tested || "";
          sensorItem.querySelector("input[name='tempSensor-system']").value = tsData.system || "";
          sensorItem.querySelector("input[name='tempSensor-comments']").value = tsData.comments || "";
        }
      }
    }
    
    function clearEntireForm() {
      document.getElementById("hygiene-checklist-form").reset();
      const imageUploads = document.querySelectorAll(".image-upload");
      imageUploads.forEach(inp => { inp.style.display = "none"; });
      const previews = document.querySelectorAll(".image-preview");
      previews.forEach(img => { img.src = ""; img.style.display = "none"; });
    }
    
    async function saveFormData() {
      const dairyNumber = document.getElementById("dairy-number").value.trim();
      if (!dairyNumber) return;
      let record = await db.forms.get(dairyNumber);
      if (!record) { record = { dairyNumber, formData: {}, creationTime: Date.now() }; }
      const form = document.getElementById("hygiene-checklist-form");
      const formDataObj = new FormData(form);
      const data = Object.fromEntries(Array.from(formDataObj.entries()).filter(([k, v]) => v.trim() !== ""));
      // Process checklist items with photo handling
      const checklistContainers = [
        ...document.getElementById("health-safety-top").children,
        ...document.getElementById("checklist-items").children,
        ...document.getElementById("silo-checklist").children
      ];
      const checklistItemsData = {};
      for (let container of checklistContainers) {
        const label = container.querySelector("label");
        if (!label) continue;
        const key = label.textContent.trim();
        const statusSelect = container.querySelector("select");
        const status = statusSelect ? statusSelect.value : "";
        const commentsInput = container.querySelector('input[type="text"]');
        let comments = commentsInput ? commentsInput.value : "";
        let imagesBase64 = [];
        const fileInputs = container.querySelectorAll('input[type="file"]');
        for (let fi of fileInputs) {
          if (fi.files && fi.files[0]) {
            const base64 = await convertFileToBase64(fi.files[0]);
            imagesBase64.push(base64);
          }
        }
        if (status === "attention-required" && imagesBase64.length > 0) {
          const photoNote = imagesBase64.length > 1 ? " (see attached photos)" : " (see attached photo)";
          comments += photoNote;
        }
        checklistItemsData[key] = { status, comments, imagesBase64 };
      }
      data.checklistItems = checklistItemsData;
      
      // Save Temperature Sensor data
      const tsContainer = document.getElementById("temperature-sensors-container");
      const tsItem = tsContainer.querySelector(".checklist-item");
      if (tsItem) {
        const tsStatus = tsItem.querySelector("select").value;
        const tsType = tsItem.querySelector("input[name='tempSensor-type']").value;
        const tsTested = tsItem.querySelector("input[name='tempSensor-tested']").value;
        const tsSystem = tsItem.querySelector("input[name='tempSensor-system']").value;
        const tsComments = tsItem.querySelector("input[name='tempSensor-comments']").value;
        data.temperatureSensors = { status: tsStatus, type: tsType, tested: tsTested, system: tsSystem, comments: tsComments };
      }
      
      record.formData = data;
      await db.forms.put(record);
    }
    
    function convertFileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    async function saveFarmDetailsToFirebase(fd) {
      const dairyNumber = fd.get("dairy-number") || "";
      if (!dairyNumber) return;
      const farmDetails = {
        dairyCompany: fd.get("dairy-company") || "",
        address: fd.get("address") || "",
        customerName: fd.get("customer-name") || "",
        region: fd.get("region") || "",
        farmName: fd.get("farm-name") || "",
        island: fd.get("island") || ""
      };
      const storageRef = storage.ref(`Agora Farm Details/${dairyNumber}.json`);
      const metadata = { contentType: "application/json" };
      try {
        await storageRef.put(new Blob([JSON.stringify(farmDetails)], { type: "application/json" }), metadata);
        console.log("Farm details saved successfully.");
      } catch (err) {
        console.error("Error saving farm details:", err);
      }
    }
    
    async function uploadPendingPDFs() {
      if (!navigator.onLine) return;
      const queuedPDFs = await db.pdfQueue.where("uploaded").equals(false).toArray();
      for (let pdfRecord of queuedPDFs) {
        try {
          await uploadSinglePDF(pdfRecord.dairyNumber, pdfRecord.fileName, pdfRecord.pdfBlob);
          await db.pdfQueue.update(pdfRecord.id, { uploaded: true });
          console.log(`Retried PDF for ${pdfRecord.dairyNumber} uploaded successfully.`);
        } catch (err) {
          console.error("Retry PDF upload failed:", err);
        }
      }
    }
    
    function uploadSinglePDF(dairyNumber, fileName, pdfBlob) {
      return new Promise((resolve, reject) => {
        const uploadRef = storage.ref(`Agora Customers/${dairyNumber}/${fileName}`);
        const task = uploadRef.put(pdfBlob);
        task.on("state_changed", null, err => reject(err), () => resolve());
      });
    }
    
    window.addEventListener("online", uploadPendingPDFs);
    
    async function generatePDF() {
      const dairyNumber = document.getElementById("dairy-number").value.trim();
      if (!dairyNumber) { alert("Please enter a Dairy Number."); return; }
      const form = document.getElementById("hygiene-checklist-form");
      const fd = new FormData(form);
      await saveFarmDetailsToFirebase(fd);
      
      // Process checklist items (with photo note) and collect photos
      const checklistContainers = [
        ...document.getElementById("health-safety-top").children,
        ...document.getElementById("checklist-items").children,
        ...document.getElementById("silo-checklist").children
      ];
      const checklistData = [];
      let pendingImages = 0;
      let photoStore = [];
      checklistContainers.forEach(item => {
        const labelEl = item.querySelector("label");
        if (!labelEl) return;
        const itemName = labelEl.textContent;
        const status = item.querySelector("select")?.value || "";
        let comments = item.querySelector("input[type='text']")?.value || "";
        const fileInputs = item.querySelectorAll("input[type='file']");
        let images = [];
        fileInputs.forEach(inp => {
          if (inp.files && inp.files[0]) { images.push(inp.files[0]); }
        });
        if (status === "attention-required" && images.length > 0) {
          const photoNote = images.length > 1 ? " (see attached photos)" : " (see attached photo)";
          comments += photoNote;
          const p = { itemName, images: [] };
          images.forEach((file, idx) => {
            pendingImages++;
            const reader = new FileReader();
            reader.onload = (evt) => {
              p.images[idx] = evt.target.result;
              pendingImages--;
              if (pendingImages === 0) finalizePDF();
            };
            reader.readAsDataURL(file);
          });
          photoStore.push(p);
        }
        checklistData.push([itemName, status, comments]);
      });
      
      // Process Temperature Sensor Data
      let tempSensorData = [];
      const tsContainer = document.getElementById("temperature-sensors-container");
      const tsItem = tsContainer.querySelector(".checklist-item");
      if (tsItem) {
        const tsType = tsItem.querySelector("input[name='tempSensor-type']").value;
        const tsTested = tsItem.querySelector("input[name='tempSensor-tested']").value;
        const tsSystem = tsItem.querySelector("input[name='tempSensor-system']").value;
        const tsComments = tsItem.querySelector("input[name='tempSensor-comments']").value;
        tempSensorData.push([tsType, tsTested, tsSystem, tsComments]);
      }
      
      // Process Flow Meters Data with extra calibration info if provided
      let flowMeters = [];
      const flowMeterMapping = {
         "Acid Flow Meter": "acid-flow",
         "Chlor Alkali Flow Meter": "chlor-flow",
         "Teat Concentrate Flow Meter": "teat-flow",
         "Water Flow Meter": "water-flow"
      };
      for (let meter in flowMeterMapping) {
         const prefix = flowMeterMapping[meter];
         const physical = fd.get(prefix + "-physical") || "";
         const system = fd.get(prefix + "-system") || "";
         flowMeters.push([meter, physical + " ml", system + " ml"]);
         // Check for extra calibration info regardless of tolerance:
         let pulseOld = fd.get(prefix + "-pulse-old") || "";
         let pulseNew = fd.get(prefix + "-pulse-new") || "";
         let newTestPhysical = fd.get(prefix + "-new-test-physical") || "";
         let newSystemResult = fd.get(prefix + "-new-system-result") || "";
         if(pulseOld || pulseNew || newTestPhysical || newSystemResult){
            let extraDetails = "";
            if(pulseOld) extraDetails += "Pulse Old: " + pulseOld;
            if(pulseNew) extraDetails += (extraDetails ? ", " : "") + "Pulse New: " + pulseNew;
            let extraDetails2 = "";
            if(newTestPhysical) extraDetails2 += "Test Physical: " + newTestPhysical;
            if(newSystemResult) extraDetails2 += (extraDetails2 ? ", " : "") + "System Result: " + newSystemResult;
            // Use a non-empty space in the first column so the row appears directly under the main row.
            flowMeters.push([" ", extraDetails, extraDetails2]);
         }
      }
      
      // Function to finalize and output PDF
      function finalizePDF() {
        const pdf = new jsPDF("p", "pt", "a4");
        let currentY = 40;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        // Draw a larger, centered logo at the top
        try {
          storage.ref("Agora Logo/6-1YdaEP.jpeg").getDownloadURL().then(url => {
            fetch(url)
              .then(res => res.blob())
              .then(blob => convertFileToBase64(blob))
              .then(logoBase64 => {
                const img = new Image();
                img.onload = function() {
                  const fixedLogoWidth = 150;
                  const fixedLogoHeight = (img.height * fixedLogoWidth) / img.width;
                  const x = (pageWidth - fixedLogoWidth) / 2;
                  pdf.addImage(logoBase64, "JPEG", x, 40, fixedLogoWidth, fixedLogoHeight);
                  currentY = 40 + fixedLogoHeight + 20;
                  addFarmDetailsAndTables(pdf);
                };
                img.src = logoBase64;
              })
              .catch(err => {
                console.error("Logo error:", err);
                addFarmDetailsAndTables(pdf);
              });
          });
        } catch (err) {
          console.error("Logo error:", err);
          addFarmDetailsAndTables(pdf);
        }
        
        function addFarmDetailsAndTables(pdf) {
          pdf.setFontSize(12);
          pdf.setFont("helvetica", "bold");
          pdf.text("Farm Details:", 40, currentY);
          currentY += 20;
          pdf.setFont("helvetica", "normal");
          pdf.text("Dairy Company: " + toTitleCase(fd.get("dairy-company") || ""), 40, currentY); currentY += 15;
          pdf.text("Dairy Number: " + (fd.get("dairy-number") || ""), 40, currentY); currentY += 15;
          pdf.text("Address: " + toTitleCase(fd.get("address") || ""), 40, currentY); currentY += 15;
          pdf.text("Customer Name: " + toTitleCase(fd.get("customer-name") || ""), 40, currentY); currentY += 15;
          pdf.text("Region: " + toTitleCase(fd.get("region") || ""), 40, currentY); currentY += 15;
          pdf.text("Farm Name: " + toTitleCase(fd.get("farm-name") || ""), 40, currentY); currentY += 15;
          pdf.text("Island: " + toTitleCase(fd.get("island") || ""), 40, currentY); currentY += 15;
          pdf.text("Visit Date: " + (fd.get("visit-date") || ""), 40, currentY); currentY += 15;
          pdf.text("Visit Type: " + (fd.get("visit-type") || ""), 40, currentY); currentY += 15;
          pdf.text("Inspection Start Time: " + (fd.get("inspection-start-time") || ""), 40, currentY); currentY += 15;
          pdf.text("Inspection End Time: " + (fd.get("inspection-end-time") || ""), 40, currentY); currentY += 15;
          pdf.text("Inspection Completed By: " + toTitleCase(fd.get("inspection-completed-by") || ""), 40, currentY); currentY += 15;
          pdf.text("Call Type: " + toTitleCase(fd.get("call-type") || ""), 40, currentY); currentY += 20;
          
          // Checklist Items Table
          pdf.setFont("helvetica", "bold");
          pdf.text("Checklist Items:", 40, currentY);
          currentY += 10;
          pdf.autoTable({
            startY: currentY,
            head: [["Item", "Status", "Comments"]],
            body: checklistData,
            styles: { fontSize: 10, cellPadding: 5 },
            headStyles: { fillColor: "#002B5C", textColor: "#fff" }
          });
          currentY = pdf.lastAutoTable.finalY + 20;
          
          // Temperature Sensors Table
          if (tempSensorData.length > 0) {
            pdf.setFont("helvetica", "bold");
            pdf.text("Temperature Sensors:", 40, currentY);
            currentY += 10;
            pdf.autoTable({
              startY: currentY,
              head: [["Sensor Type", "Tested Temp (°C)", "System Temp (°C)", "Comments"]],
              body: tempSensorData,
              styles: { fontSize: 10, cellPadding: 5 },
              headStyles: { fillColor: "#002B5C", textColor: "#fff" }
            });
            currentY = pdf.lastAutoTable.finalY + 20;
          }
          
          // Flow Meters Table (with extra calibration details row if provided)
          if (flowMeters.length > 0) {
            pdf.setFont("helvetica", "bold");
            pdf.text("Flow Meters:", 40, currentY);
            currentY += 10;
            pdf.autoTable({
              startY: currentY,
              head: [["Meter", "Physical Test", "System Read"]],
              body: flowMeters,
              styles: { fontSize: 10, cellPadding: 5 },
              headStyles: { fillColor: "#002B5C", textColor: "#fff" }
            });
            currentY = pdf.lastAutoTable.finalY + 20;
          }
          
          // Attached Photos Section – photos now drawn 2.5× larger (width = 250px)
          if (photoStore.length > 0) {
            pdf.setFont("helvetica", "bold");
            if (currentY + 20 > pageHeight) {
              pdf.addPage();
              currentY = 40;
            }
            pdf.text("Attached Photos:", 40, currentY);
            currentY += 20;
            photoStore.forEach(photoItem => {
              if (currentY + 15 > pageHeight) {
                pdf.addPage();
                currentY = 40;
              }
              pdf.setFont("helvetica", "bold");
              pdf.text(photoItem.itemName, 40, currentY);
              currentY += 15;
              let maxImgHeight = 0;
              photoItem.images.forEach((img, idx) => {
                try {
                  const imgProps = pdf.getImageProperties(img);
                  const imgWidth = 250;
                  const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                  if (currentY + imgHeight > pageHeight) {
                    pdf.addPage();
                    currentY = 40;
                  }
                  pdf.addImage(img, "JPEG", 40 + idx * (imgWidth + 10), currentY, imgWidth, imgHeight);
                  if (imgHeight > maxImgHeight) maxImgHeight = imgHeight;
                } catch(e) {
                  console.error("Error adding image:", e);
                }
              });
              currentY += maxImgHeight + 20;
            });
          }
          
          const pdfBlob = pdf.output("blob");
          const timestamp = new Date().toISOString().split("T")[0];
          const fileName = `${fd.get("dairy-number")}-form-${timestamp}.pdf`;
          let uploadSuccessful = false;
          if (navigator.onLine) {
            uploadSinglePDF(fd.get("dairy-number"), fileName, pdfBlob).then(() => {
              uploadSuccessful = true;
              console.log("PDF uploaded to Agora Customers folder.");
            }).catch(err => {
              console.error("PDF upload failed:", err);
            });
          }
          if (!uploadSuccessful) {
            db.pdfQueue.add({ dairyNumber: fd.get("dairy-number"), fileName, pdfBlob, uploaded: false });
            console.log("PDF upload queued for later retry.");
          }
          db.forms.delete(fd.get("dairy-number"));
          pdf.save(`Agora_Form_${fd.get("dairy-number")}.pdf`);
          uploadPendingPDFs();
          clearEntireForm();
          location.reload();
        }
      }
      
      if (pendingImages === 0) {
        finalizePDF();
      }
    }
    
    function viewRecords() {
      document.getElementById("form-container").style.display = "none";
      document.getElementById("record-container").style.display = "block";
      loadAllRecords();
    }
    
    async function loadAllRecords() {
      const recordList = document.getElementById("record-list");
      recordList.innerHTML = "";
      const storageRef = storage.ref("Agora Customers");
      try {
        const folderSnapshot = await storageRef.listAll();
        folderSnapshot.prefixes.forEach(folderRef => {
          const dairyNumber = folderRef.name;
          const link = document.createElement("a");
          link.textContent = dairyNumber;
          link.href = "#";
          link.addEventListener("click", () => loadRecordFiles(dairyNumber));
          recordList.appendChild(link);
        });
      } catch (error) {
        console.error("Error fetching records:", error);
      }
    }
    
    async function loadRecordFiles(dairyNumber) {
      const recordList = document.getElementById("record-list");
      recordList.innerHTML = "";
      const folderRef = storage.ref(`Agora Customers/${dairyNumber}`);
      try {
        const fileSnapshot = await folderRef.listAll();
        fileSnapshot.items.forEach(fileRef => {
          const fileName = fileRef.name;
          const dateMatch = fileName.match(/(\d{4}-\d{2}-\d{2})/);
          const displayName = dateMatch ? dateMatch[0] : fileName;
          const fileLink = document.createElement("a");
          fileLink.textContent = displayName;
          fileLink.href = "#";
          fileLink.addEventListener("click", async () => {
            try {
              const url = await fileRef.getDownloadURL();
              window.open(url, "_blank");
            } catch (err) {
              console.error("Error fetching file:", err);
            }
          });
          recordList.appendChild(fileLink);
        });
        const backBtn = document.createElement("button");
        backBtn.textContent = "Back to Records";
        backBtn.className = "back-button";
        backBtn.addEventListener("click", loadAllRecords);
        recordList.appendChild(backBtn);
      } catch (err) {
        console.error("Error fetching record files:", err);
      }
    }
    
    function filterRecords() {
      const searchValue = document.getElementById("search-dairy-number").value.toLowerCase();
      const recordList = document.getElementById("record-list");
      const links = recordList.getElementsByTagName("a");
      for (let i = 0; i < links.length; i++) {
        const txt = links[i].textContent || links[i].innerText;
        links[i].style.display = txt.toLowerCase().includes(searchValue) ? "" : "none";
      }
    }
    
    function goBack() {
      document.getElementById("form-container").style.display = "block";
      document.getElementById("record-container").style.display = "none";
    }
    
    function setupFlowMeterTolerance(physicalId, systemId, calibrationId) {
      const physicalInput = document.getElementById(physicalId);
      const systemInput = document.getElementById(systemId);
      const calibrationContainer = document.getElementById(calibrationId);
      function updateCalibrationDisplay() {
        const physicalValue = parseFloat(physicalInput.value);
        const systemValue = parseFloat(systemInput.value);
        if (!isNaN(physicalValue) && !isNaN(systemValue)) {
          const tolerance = 0.05 * physicalValue;
          calibrationContainer.style.display = (Math.abs(physicalValue - systemValue) > tolerance) ? "block" : "none";
        } else {
          calibrationContainer.style.display = "none";
        }
      }
      physicalInput.addEventListener("input", updateCalibrationDisplay);
      systemInput.addEventListener("input", updateCalibrationDisplay);
    }
    
    document.addEventListener("DOMContentLoaded", async () => {
      const fieldsToAutoCap = ["dairy-number", "dairy-company", "address", "customer-name", "farm-name", "inspection-completed-by"];
      fieldsToAutoCap.forEach(autoCapitalizeInput);
      await setupDairyCompanyDatalist();
      createHealthSafetyItems("health-safety-top");
      createChecklistItems();
      createSiloChecklist();
      createTemperatureSensorItem();
      const form = document.getElementById("hygiene-checklist-form");
      form.addEventListener("input", saveFormData);
      form.addEventListener("change", saveFormData);
      uploadPendingPDFs();
      setupFlowMeterTolerance("acid-flow-physical", "acid-flow-system", "acid-calibration");
      setupFlowMeterTolerance("chlor-flow-physical", "chlor-flow-system", "chlor-calibration");
      setupFlowMeterTolerance("teat-flow-physical", "teat-flow-system", "teat-calibration");
      setupFlowMeterTolerance("water-flow-physical", "water-flow-system", "water-calibration");
    });
  </script>
</body>
</html>
